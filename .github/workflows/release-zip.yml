name: Create release zip

on:
    release:
        types: [published]
    # allow manual runs from the Actions UI
    workflow_dispatch:
        inputs:
            tag:
                description: "Release tag to upload to (if empty, will attempt to use event data)"
                required: false
                default: ""

permissions:
    contents: write

jobs:
    build-and-upload:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Determine release tag
              id: prep_tag
              run: |
                  set -euo pipefail
                  TAG_FROM_EVENT="${{ github.event.release.tag_name }}"
                  INPUT_TAG="${{ github.event.inputs.tag }}"
                  if [ -n "${TAG_FROM_EVENT:-}" ]; then
                      TAG="${TAG_FROM_EVENT}"
                  else
                      TAG="${INPUT_TAG}"
                  fi
                  if [ -z "${TAG}" ]; then
                      echo "Error: unable to determine tag. Provide a 'tag' when running manually." >&2
                      exit 1
                  fi
                  echo "tag=${TAG}" >> $GITHUB_OUTPUT

            - name: Create zip archive
              run: |
                  set -euo pipefail
                  TAG=${{ steps.prep_tag.outputs.tag }}
                  ZIP_NAME="control-rig-tools-${TAG}.zip"
                  rm -f "${ZIP_NAME}" || true
                  rm -rf "Control Rig Tools" || true
                  mkdir -p "Control Rig Tools"
                  rsync -a --exclude='.git' --exclude='.github/workflows' --exclude='release-*.zip' ./ "Control Rig Tools/"
                  zip -r "${ZIP_NAME}" "Control Rig Tools"

            - name: Upload release asset
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  # these are populated when the workflow is triggered by a release event
                  UPLOAD_URL_TEMPLATE: ${{ github.event.release.upload_url }}
                  RELEASE_TAG_FROM_EVENT: ${{ github.event.release.tag_name }}
                  REPO: ${{ github.repository }}
              run: |
                  set -euo pipefail
                  TAG=${{ steps.prep_tag.outputs.tag }}
                  # Determine upload URL: if triggered by release event use template, else lookup/create release
                  if [ -n "${RELEASE_TAG_FROM_EVENT:-}" ]; then
                      UPLOAD_URL="${UPLOAD_URL_TEMPLATE%%\{*}"
                  else
                      API="https://api.github.com/repos/${REPO}"
                      echo "Looking up release for tag ${TAG}"
                      resp=$(curl -sS -H "Authorization: token ${GITHUB_TOKEN}" "${API}/releases/tags/${TAG}" || true)
                      upload_url=$(echo "$resp" | jq -r .upload_url 2>/dev/null || true)
                      if [ -z "${upload_url}" ] || [ "${upload_url}" = "null" ]; then
                          echo "Release not found; creating release ${TAG}"
                          create_resp=$(curl -sS -X POST -H "Authorization: token ${GITHUB_TOKEN}" -H "Content-Type: application/json" -d "{\"tag_name\":\"${TAG}\",\"name\":\"${TAG}\",\"prerelease\":false}" "${API}/releases")
                          upload_url=$(echo "$create_resp" | jq -r .upload_url)
                      fi
                      if [ -z "${upload_url}" ] || [ "${upload_url}" = "null" ]; then
                          echo "Failed to obtain upload_url for release ${TAG}" >&2
                          exit 1
                      fi
                      UPLOAD_URL="${upload_url%%\{*}"
                  fi

                  ASSET_NAME="control-rig-tools-${TAG}.zip"
                  echo "Uploading ${ASSET_NAME} to ${UPLOAD_URL}"
                  curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
                      -H "Content-Type: application/zip" \
                      --data-binary @"${ASSET_NAME}" "${UPLOAD_URL}?name=${ASSET_NAME}"
