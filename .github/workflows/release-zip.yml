name: Create release zip

on:
    release:
        types: [published]

permissions:
    contents: write

jobs:
    build-and-upload:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Create zip archive
              run: |
                  rm -f release.zip || true
                  zip -r release.zip . -x ".git/*" ".github/workflows/*" "release.zip"

            - name: Upload release asset
              name: Upload release asset (curl)
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  ASSET_NAME="release-${{ github.event.release.tag_name }}.zip"
                  # upload_url has a template suffix like "...{?name,label}"; trim it
                  UPLOAD_URL="${{ github.event.release.upload_url }}"
                  UPLOAD_URL="${UPLOAD_URL%%\{*}"
                  echo "Uploading ${ASSET_NAME} to ${UPLOAD_URL}"
                  curl -sS -H "Authorization: token ${GITHUB_TOKEN}" \
                      -H "Content-Type: application/zip" \
                      --data-binary @release.zip "${UPLOAD_URL}?name=${ASSET_NAME}"
